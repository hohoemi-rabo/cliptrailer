# 08. 動画書き出し（Step⑥）

## 概要

画像・音声・BGMを合成して最終的な動画ファイルを生成する。

## 完了条件

- mp4動画が生成・ダウンロードできる
- 字幕ON/OFFが選択できる
- サムネイル画像が生成される
- キャプション・ハッシュタグが生成される

## 技術仕様

| 項目 | 内容 |
|------|------|
| 出力形式 | mp4 |
| 解像度 | 1080×1920（縦動画） |
| 動画の尺 | 15秒固定（MVP） |
| 動画合成 | FFmpeg（サーバーサイド） |
| 処理方式 | 非同期（ジョブキュー） |

## タスク

- [ ] FFmpegによる動画合成処理
- [ ] 非同期処理の実装（Inngest/Trigger.dev）
- [ ] 字幕ON/OFF選択UI
- [ ] 字幕の動画焼き込み処理
- [ ] サムネイル自動生成（1枚目の画像）
- [ ] キャプション自動生成（AI）
- [ ] ハッシュタグ自動生成（AI）
- [ ] 動画生成進捗表示
- [ ] 動画ダウンロード機能
- [ ] 完了画面の実装
- [ ] 生成失敗時の再生成ボタン

## アーキテクチャ

```
ユーザー → Vercel（受付）→ ジョブキュー → 動画処理サーバー → 完了通知
                                              ↓
                                         Supabase Storage
```

## 動画合成フロー

1. 4枚の画像を取得
2. 各画像の表示時間を計算（音声に合わせる）
3. 音声ファイルを取得
4. BGMファイルを取得（選択されている場合）
5. FFmpegで合成
   - 画像をスライドショー化
   - 音声を重ねる
   - BGMをミックス（音量調整）
   - 字幕を焼き込み（ONの場合）
6. mp4を出力
7. Supabase Storageに保存

## UI設計（完了画面）

```
┌────────────────────────────────────┐
│ 動画が完成しました！                │
├────────────────────────────────────┤
│ [動画プレビュー]                   │
│                                    │
│ [ダウンロード]                     │
├────────────────────────────────────┤
│ キャプション:                      │
│ ┌──────────────────────────────┐  │
│ │ コピー用テキスト...          │  │
│ └──────────────────────────────┘  │
│ [コピー]                           │
├────────────────────────────────────┤
│ ハッシュタグ:                      │
│ #note #TikTok #ショート動画...     │
│ [コピー]                           │
└────────────────────────────────────┘
```

## データ構造

```typescript
interface ExportedVideo {
  id: string
  videoUrl: string
  thumbnailUrl: string
  caption: string
  hashtags: string[]
  subtitlesEnabled: boolean
  duration: number
  createdAt: Date
  expiresAt: Date // 7日後
}
```
